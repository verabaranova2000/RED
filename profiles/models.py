import jax.numpy as jnp  # type: ignore
import numpy as np
from utils.format import get_value

## ======== Модель: полиномы Лежандра ========

## --- Полиномы Лежандра P(n,x) ---
def P_legendre(n,x):
  poly_map = {             # словарь "степень: функция"
  0: lambda x: jnp.ones_like(x),
  1: lambda x: x,
  2: lambda x: 0.5*(3*x**2-1),
  3: lambda x: 0.5*(5*x**3-3*x),
  4: lambda x: 1/8*(35*x**4-30*x**2+3),
  5: lambda x: 1/8*(63*x**5-70*x**3+15*x),
  6: lambda x: 1/16*(231*x**6-315*x**4+105*x**2-5),
  7: lambda x: 1/16*(429*x**7-693*x**5+315*x**3-35*x),
  8: lambda x: 1/128*(6435*x**8-12012*x**6+6930*x**4-1260*x**2+35),
  9: lambda x: 1/128*(12155*x**9-25740*x**7+18018*x**5-4620*x**3+315*x),
  10: lambda x: 1/256*(46189*x**10-109395*x**8+90090*x**6-30030*x**4+3465*x**2-63),
  11: lambda x: 1/256*(88179*x**11-230945*x**9+218790*x**7-90090*x**5+15015*x**3-693*x),
  12: lambda x: 1/1024*(676039*x**12-1939938*x**10+2078505*x**8-1021020*x**6+225225*x**4-18018*x**2+231),
  13: lambda x: 1/1024*(1300075*x**13-4056234*x**11+4849845*x**9-2771340*x**7+765765*x**5-90090*x**3+3003*x),
  14: lambda x: 1/2048*(5014575*x**14-16900975*x**12+22309287*x**10-14549535*x**8+4849845*x**6-765765*x**4+45045*x**2-429),
  15: lambda x: 1/2048*(9694845*x**15-35102025*x**13+50702925*x**11-37182145*x**9+14549535*x**7-2909907*x**5+255255*x**3-6435*x),
  16: lambda x: 1/32768*(300540195*x**16-1163381400*x**14+1825305300*x**12-1487285800*x**10+669278610*x**8-162954792*x**6+19399380*x**4-875160*x**2+6435),
  17: lambda x: 1/32768*(583401555*x**17-2404321560*x**15+4071834900*x**13-3650610600*x**11+1859107250*x**9-535422888*x**7+81477396*x**5-5542680*x**3+109395*x),
  18: lambda x: 2268783825/65536*x**18-9917826435/65536*x**16+4508102925/16384*x**14-4411154475/16384*x**12+5019589575/32768*x**10-1673196525/32768*x**8+156165009/16384*x**6-14549535/16384*x**4+2078505/65536*x**2-12155/65536*x**0,
  19: lambda x: 4418157975/65536*x**19-20419054425/65536*x**17+9917826435/16384*x**15-10518906825/16384*x**13+13233463425/32768*x**11-5019589575/32768*x**9+557732175/16384*x**7-66927861/16384*x**5+14549535/65536*x**3-230945/65536*x**1,
  20: lambda x: 34461632205/262144*x**20-83945001525/131072*x**18+347123925225/262144*x**16-49589132175/32768*x**14+136745788725/131072*x**12-29113619535/65536*x**10+15058768725/131072*x**8-557732175/32768*x**6+334639305/262144*x**4-4849845/131072*x**2+46189/262144*x**0,
  21: lambda x: 67282234305/262144*x**21-172308161025/131072*x**19+755505013725/262144*x**17-115707975075/32768*x**15+347123925225/131072*x**13-82047473235/65536*x**11+48522699225/131072*x**9-2151252675/32768*x**7+1673196525/262144*x**5-37182145/131072*x**3+969969/262144*x**1,
  22: lambda x: 263012370465/524288*x**22-1412926920405/524288*x**20+3273855059475/524288*x**18-4281195077775/524288*x**16+1735619626125/262144*x**14-902522205585/262144*x**12+300840735195/262144*x**10-62386327575/262144*x**8+15058768725/524288*x**6-929553625/524288*x**4+22309287/524288*x**2-88179/524288*x**0,
  23: lambda x: 514589420475/524288*x**23-2893136075115/524288*x**21+7064634602025/524288*x**19-9821565178425/524288*x**17+4281195077775/262144*x**15-2429867476575/262144*x**13+902522205585/262144*x**11-214886239425/262144*x**9+62386327575/524288*x**7-5019589575/524288*x**5+185910725/524288*x**3-2028117/524288*x**1,
  24: lambda x: 8061900920775/4194304*x**24-11835556670925/1048576*x**22+60755857577415/2097152*x**20-44742685812825/1048576*x**18+166966608033225/4194304*x**16-12843585233325/524288*x**14+10529425731825/1048576*x**12-1418249180205/524288*x**10+1933976154825/4194304*x**8-48522699225/1048576*x**6+5019589575/2097152*x**4-50702925/1048576*x**2+676039/4194304*x**0,
  25: lambda x: 15801325804719/4194304*x**25-24185702762325/1048576*x**23+130191123380175/2097152*x**21-101259762629025/1048576*x**19+402684172315425/4194304*x**17-33393321606645/524288*x**15+29968365544425/1048576*x**13-4512611027925/524288*x**11+7091245901025/4194304*x**9-214886239425/1048576*x**7+29113619535/2097152*x**5-456326325/1048576*x**3+16900975/4194304*x**1,
  26: lambda x: 61989816618513/8388608*x**26-395033145117975/8388608*x**24+556271163533475/4194304*x**22-911337863661225/4194304*x**20+1923935489951475/8388608*x**18-1369126185872445/8388608*x**16+166966608033225/2097152*x**14-55655536011075/2097152*x**12+49638721307175/8388608*x**10-7091245901025/8388608*x**8+300840735195/4194304*x**6-13233463425/4194304*x**4+456326325/8388608*x**2-1300075/8388608*x**0,
  27: lambda x: 121683714103007/8388608*x**27-805867616040669/8388608*x**25+1185099435353925/4194304*x**23-2039660932956075/4194304*x**21+4556689318306125/8388608*x**19-3463083881912655/8388608*x**17+456375395290815/2097152*x**15-166966608033225/2097152*x**13+166966608033225/8388608*x**11-27577067392875/8388608*x**9+1418249180205/4194304*x**7-82047473235/4194304*x**5+4411154475/8388608*x**3-35102025/8388608*x**1,
  28: lambda x: 956086325095055/33554432*x**28-3285460280781189/16777216*x**26+20146690401016725/33554432*x**24-9085762337713425/8388608*x**22+42832879592077575/33554432*x**20-17315419409563275/16777216*x**18+19624141997505045/33554432*x**16-977947275623175/4194304*x**14+2170565904431925/33554432*x**12-204070298707275/16777216*x**10+49638721307175/33554432*x**8-902522205585/8388608*x**6+136745788725/33554432*x**4-1017958725/16777216*x**2+5014575/33554432*x**0,
  29: lambda x: 1879204156221315/33554432*x**29-6692604275665385/16777216*x**27+42710983650155457/33554432*x**25-20146690401016725/8388608*x**23+99943385714847675/33554432*x**21-42832879592077575/16777216*x**19+51946258228689825/33554432*x**17-2803448856786435/4194304*x**15+6845630929362225/33554432*x**13-723521968143975/16777216*x**11+204070298707275/33554432*x**9-4512611027925/8388608*x**7+902522205585/33554432*x**5-10518906825/16777216*x**3+145422675/33554432*x**1,
  30: lambda x: 7391536347803839/67108864*x**30-54496920530418135/67108864*x**28+180700315442965395/67108864*x**26-355924863751295475/67108864*x**24+463373879223384675/67108864*x**22-419762220002360235/67108864*x**20+271274904083157975/67108864*x**18-126155198555389575/67108864*x**16+42051732851796525/67108864*x**14-9888133564634325/67108864*x**12+1591748329916745/67108864*x**10-166966608033225/67108864*x**8+10529425731825/67108864*x**6-347123925225/67108864*x**4+4508102925/67108864*x**2-9694845/67108864*x**0}
  if n not in poly_map:
    raise ValueError(f"Полином степени {n} не реализован")
  return poly_map[n](x)

## --- Сумма полиномов Лежандра ---
def Background(axes, **pars):
    x          = jnp.array(axes)
    bckg_items = [(int(k.replace('bckg','')), get_value(v))  # фильтруем параметры с 'bckg'
                  for k,v in pars.items() if 'bckg' in k]
    if not bckg_items:
        return jnp.zeros_like(x)
    degrees, coefs = zip(*bckg_items)
    coefs          = jnp.array(coefs)
    # --- Векторизованное суммирование: bckg_n * P_n(x) ---
    B = jnp.sum(jnp.array([coef * P_legendre(n, x) for n, coef in zip(degrees, coefs)]), axis=0)
    return np.array(B)